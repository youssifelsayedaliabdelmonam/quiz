<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงุฎุชุจุงุฑ ุงูุญุงุณูุจ ุงููุชูุงูู</title>
    <!-- ุชุถููู Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* ูุถูุงู ุงุณุชุฎุฏุงู ุฎุท ุนุฑุจู ุฃููู */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f7f9fb;
        }
        .container-card {
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.08);
        }
        .timer-display {
            /* ูุถูุงู ุซุจุงุช ุงูุฃุฑูุงู ุนูุฏ ุชุบููุฑ ุงูููุช */
            font-variant-numeric: tabular-nums; 
        }
        .correct-answer {
            background-color: #d1fae5; /* ุฃุฎุถุฑ ูุงุชุญ */
            border-right: 4px solid #10b981; 
        }
        .incorrect-answer {
            background-color: #fee2e2; /* ุฃุญูุฑ ูุงุชุญ */
            border-right: 4px solid #ef4444; 
        }
        .user-selected-mcq {
            background-color: #bfdbfe; /* ุฃุฒุฑู ูุงุชุญ */
            font-weight: 600;
        }
        .question-block:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 flex items-center justify-center">

<div id="app" class="w-full max-w-4xl">
    <!-- ุญุงููุฉ ุงูุชุทุจูู ุงูุฑุฆูุณูุฉ ุณูุชู ููุคูุง ุฏููุงููููุงู -->
</div>

<script type="module">
    // --- ุงุณุชูุฑุงุฏุงุช Firebase ูุงูุฎุฏูุงุช ุงููุณุงุนุฏุฉ ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- ุงูุซูุงุจุช ูุงูุจูุงูุงุช ุงูุฃูููุฉ ---
    const EXAM_DURATION = 45 * 60; // 45 ุฏูููุฉ ุจุงูุซูุงูู = 2700 ุซุงููุฉ
    const GEMINI_API_KEY = ""; // ููุชุงุญ API ูู Gemini

    // ุฃุณุฆูุฉ ุงูุงุฎุชูุงุฑุงุช ุงููุชุนุฏุฏุฉ (MCQ) - 20 ุณุคุงู
    const mcqQuestions = [
        { id: 1, text: 'First-generation computers used:', options: ['Vacuum Tubes', 'Transistors', 'ICs', 'Microprocessors'], correct: 'Vacuum Tubes' },
        { id: 2, text: 'Fifth-generation computers are mainly based on:', options: ['AI', 'ICs', 'Assembly language', 'Transistors'], correct: 'AI' },
        { id: 3, text: 'The fastest type of computer is the:', options: ['Microcomputer', 'Minicomputer', 'Mainframe', 'Supercomputer'], correct: 'Supercomputer' },
        { id: 4, text: 'The component responsible for arithmetic and logic operations is:', options: ['CU', 'ALU', 'Cache', 'Registers'], correct: 'ALU' },
        { id: 5, text: 'Which type of memory is volatile?', options: ['ROM', 'RAM', 'Hard Disk', 'SSD'], correct: 'RAM' },
        { id: 6, text: 'Cache memory is used to store:', options: ['Program files', 'Frequently used data', 'Operating system', 'User data'], correct: 'Frequently used data' },
        { id: 7, text: 'Which of the following stores BIOS?', options: ['RAM', 'ROM', 'Cache', 'Hard Disk'], correct: 'ROM' },
        { id: 8, text: 'Computer speed is measured in:', options: ['Bytes', 'Hertz', 'Watts', 'Pixels'], correct: 'Hertz' },
        { id: 9, text: 'The correct instruction cycle order is:', options: ['Fetch โ Decode โ Execute', 'Decode โ Execute โ Fetch', 'Execute โ Fetch โ Decode', 'Fetch โ Execute โ Decode'], correct: 'Fetch โ Decode โ Execute' },
        { id: 10, text: 'Which device is both input and output?', options: ['Touch screen', 'Scanner', 'Printer', 'Keyboard'], correct: 'Touch screen' },
        // ุฃุณุฆูุฉ ุงูุชุญูููุงุช ุงูุฑูููุฉ
        { id: 11, text: 'What is the binary representation of decimal 47?', options: ['110111', '101111', '110011', '111001'], correct: '101111' },
        { id: 12, text: 'The binary equivalent of hexadecimal A2 is:', options: ['10100010', '10010001', '11100010', '10101010'], correct: '10100010' },
        { id: 13, text: 'The binary representation of hexadecimal 3D is:', options: ['00111101', '01010101', '01110011', '01011100'], correct: '00111101' },
        { id: 14, text: 'The decimal value of octal 57 is:', options: ['46', '47', '48', '55'], correct: '47' },
        { id: 15, text: 'The binary equivalent of octal 45 is:', options: ['100101', '101110', '101101', '100110'], correct: '100101' }, 
        { id: 16, text: 'The result of adding 10101 + 01001 is:', options: ['11110', '11000', '10000', '11100'], correct: '11110' },
        // ุฃุณุฆูุฉ ุงูุจุฑูุฌูุงุช
        { id: 17, text: 'Which of the following is system software?', options: ['Windows', 'Word', 'Photoshop', 'Chrome'], correct: 'Windows' },
        { id: 18, text: 'The operating system mainly:', options: ['Manages hardware resources', 'Draws graphics', 'Edits audio files', 'Compiles programs'], correct: 'Manages hardware resources' },
        { id: 19, text: 'An assembler is used to:', options: ['Translate assembly to machine code', 'Translate machine code to high level', 'Debug code', 'Link program files'], correct: 'Translate assembly to machine code' },
        { id: 20, text: 'Which of the following is NOT a high-level language?', options: ['Java', 'Python', 'C#', 'Assembly'], correct: 'Assembly' },
    ].map(q => ({...q, type: 'mcq', scoreValue: 1}));

    // ุงูุฃุณุฆูุฉ ุงููุธุฑูุฉ (Written) - 13 ุณุคุงู
    const writtenQuestions = [
        { id: 21, text: 'Explain the difference between first-generation and second-generation computers.', modelAnswer: 'First-generation (1940sโ1950s) used vacuum tubes, were large, consumed a lot of power, and generated heat. Second-generation (1950sโ1960s) used transistors, were smaller, faster, more reliable, and consumed less power.' },
        { id: 22, text: 'What is meant by computer accuracy, and why is it important?', modelAnswer: 'Accuracy is the ability of a computer to produce correct results. Important because even small errors can cause major problems in calculations, data processing, and decision-making.' },
        { id: 23, text: 'Describe the function of the Control Unit (CU) inside the CPU.', modelAnswer: 'The CU directs and coordinates the operations of the CPU. It fetches instructions, decodes them, and sends control signals to other components for execution.' },
        { id: 24, text: 'Describe the role of Cache Memory in a computer system.', modelAnswer: 'Cache is high-speed memory near the CPU. Stores frequently used data and instructions to reduce access time and increase processing speed.' },
        { id: 25, text: 'List and explain the stages of the Instruction Cycle.', modelAnswer: 'Fetch: Retrieve instruction from memory. Decode: Interpret the instruction. Execute: Perform the operation. Store (optional): Save the result back to memory or registers.' },
        { id: 26, text: 'What is the function of the BIOS during system startup?', modelAnswer: 'BIOS (Basic Input/Output System) initializes hardware, performs POST (Power-On Self Test), and loads the operating system into RAM.' },
        { id: 27, text: 'Distinguish between a Supercomputer and a Mainframe computer.', modelAnswer: 'Supercomputer: Extremely fast, used for scientific calculations, simulations, weather forecasting. Mainframe: Large, powerful, handles many users and large-scale transaction processing (banks, airlines).' },
        { id: 28, text: 'Explain the difference between System Software and Application Software.', modelAnswer: 'System Software: Manages hardware, provides platform for applications (e.g., OS, drivers). Application Software: Helps users perform tasks (e.g., Word, Photoshop).' },
        { id: 29, text: 'Describe the main role of the Kernel in an operating system.', modelAnswer: 'The Kernel is the core part of the OS, managing CPU, memory, processes, and hardware communication with software.' },
        { id: 30, text: 'Describe the role of Registers inside the CPU.', modelAnswer: 'Registers are small, high-speed storage locations in the CPU used to temporarily hold data, instructions, or addresses during processing.' },
        { id: 31, text: 'What is a Bus in computer architecture and what are its main types?', modelAnswer: 'A Bus is a communication pathway for data transfer between CPU, memory, and peripherals. Main types: Data bus, Address bus, Control bus.' },
        { id: 32, text: 'Explain the difference between the Northbridge and Southbridge chips on a motherboard.', modelAnswer: 'Northbridge: Connects CPU to RAM and GPU, handles high-speed data. Southbridge: Handles I/O devices, storage, and slower peripherals.' },
        { id: 33, text: 'Describe how increasing the size of RAM affects the performance of a computer.', modelAnswer: 'More RAM allows more programs to run simultaneously and more data to be held in fast memory, reducing reliance on slower storage and improving performance.' },
    ].map(q => ({...q, type: 'written', scoreValue: 0}));


    // --- ุญุงูุฉ ุงูุชุทุจูู (State) ---
    const state = {
        screen: 'loading', // 'loading', 'register', 'exam', 'results'
        studentName: '',
        seatNumber: '',
        timerInterval: null,
        timeLeft: EXAM_DURATION,
        answers: {}, // { questionId: answer }
        mcqScore: 0,
        sessionId: null, // ุงููุนุฑู ุงููุฑูุฏ ููุฌูุณุฉ
        examQuestions: [...mcqQuestions, ...writtenQuestions], // ุฌููุน ุงูุฃุณุฆูุฉ
        isAuthReady: false, // ุนูุงูุฉ ุฌุงูุฒูุฉ Firebase
        errorMessage: null, // ูุนุฑุถ ุฃุฎุทุงุก ุงูุฌูุณุฉ
        explanationCache: {}, // ุชุฎุฒูู ูุคูุช ููุดุฑูุญุงุช ุงูุชู ุชู ุชูููุฏูุง
        audioPlayer: new Audio(), // ูุดุบู ุงูุตูุช
        audioQuestionId: null, // ูุนุฑู ุงูุณุคุงู ุงูุฐู ูุชู ุชุดุบููู ุญุงูููุง
    };

    const app = document.getElementById('app');

    // --- ุฅุนุฏุงุฏ Firebase (ููุณ ุงูุฅุนุฏุงุฏ ุงูุณุงุจู) ---
    let db, auth;
    let userId = 'anonymous'; 

    async function initializeFirebase() {
        try {
            setLogLevel('Debug');
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            
            if (firebaseConfig) {
                const appInstance = initializeApp(firebaseConfig);
                db = getFirestore(appInstance);
                auth = getAuth(appInstance);

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                // ุญุงูู ุชุณุฌูู ุงูุฏุฎูู ุจุงูุฑูุฒ ุงููููุฒ ุงููุฎุตุต ุฃู ูุฌููู
                await new Promise(async (resolve, reject) => {
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (e) {
                            console.warn("Custom token sign-in failed. Falling back to anonymous.");
                            await signInAnonymously(auth);
                        }
                    } else {
                        await signInAnonymously(auth);
                    }
                    resolve();
                });
                
                userId = auth.currentUser?.uid || crypto.randomUUID();
                state.isAuthReady = true;

                await checkExistingSession();

            } else {
                // ูุดู ูู ุงูุนุซูุฑ ุนูู ุชููุฆุฉ Firebase. ุณูุชู ุงูุณูุงุญ ุจุงูุจุฏุก ูููู ุจุฏูู ุชุฎุฒูู ุฏุงุฆู.
                console.error("Firebase config not found. Running in offline/no-persistence mode.");
                state.isAuthReady = false; 
                state.screen = 'register';
                render();
            }
        } catch (e) {
            // ุฎุทุฃ ุนุงู ูู ุงูุชููุฆุฉ ุฃู ุงูุงุชุตุงู
            console.error("Firebase initialization failed:", e);
            state.errorMessage = `ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุฎุฏูุฉ ุงูุชุฎุฒูู. ${e.message}`;
            state.screen = 'register';
            state.isAuthReady = false; 
            render();
        }
    }

    function getSessionRef(sessionId) {
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        return doc(db, `artifacts/${appId}/public/data/exams`, sessionId);
    }

    async function saveSession(data) {
        if (!db || !state.sessionId) return;
        const sessionRef = getSessionRef(state.sessionId);
        await setDoc(sessionRef, data, { merge: true });
    }

    async function loadSession(sessionId) {
        if (!db) return null;
        const sessionRef = getSessionRef(sessionId);
        const sessionSnap = await getDoc(sessionRef);
        return sessionSnap.exists() ? sessionSnap.data() : null;
    }

    async function checkExistingSession() {
        if (!state.isAuthReady || !db) {
            state.screen = 'register';
            render();
            return;
        }

        const storedSessionId = localStorage.getItem('current_exam_session_id');

        if (storedSessionId) {
            try {
                const sessionData = await loadSession(storedSessionId);
                
                if (sessionData && sessionData.status === 'completed') {
                    state.sessionId = storedSessionId;
                    state.studentName = sessionData.studentName;
                    state.seatNumber = sessionData.seatNumber;
                    state.answers = sessionData.answers;
                    state.mcqScore = sessionData.mcqScore;
                    state.screen = 'results';
                } else if (sessionData && sessionData.status === 'active') {
                    state.sessionId = storedSessionId;
                    state.studentName = sessionData.studentName;
                    state.seatNumber = sessionData.seatNumber;
                    state.answers = sessionData.answers || {};
                    const elapsedSeconds = Math.floor((new Date() - new Date(sessionData.startTime)) / 1000);
                    state.timeLeft = Math.max(0, EXAM_DURATION - elapsedSeconds);
                    
                    if (state.timeLeft === 0) {
                        await handleSubmitExam(true); 
                        return;
                    }

                    state.screen = 'exam';
                    startTimer();
                } else {
                    state.screen = 'register';
                }
            } catch (e) {
                console.error("Error checking session:", e);
                state.errorMessage = 'ุญุฏุซ ุฎุทุฃ ูู ุงุณุชุฆูุงู ุงูุฌูุณุฉ. (ูุฏ ุชููู ูุดููุฉ ุงุชุตุงู ุจุงูุดุจูุฉ).';
                state.screen = 'register';
            }
        } else {
            state.screen = 'register';
        }
        render();
    }


    // --- ููุทู ุงููุคูุช (Timer) ---

    function startTimer() {
        if (state.timerInterval) clearInterval(state.timerInterval);

        state.timerInterval = setInterval(() => {
            if (state.timeLeft > 0) {
                state.timeLeft--;
            }
            
            if (state.timeLeft <= 0) {
                clearInterval(state.timerInterval);
                state.timeLeft = 0;
                handleSubmitExam(true); // ุฅุฑุณุงู ุชููุงุฆู ุนูุฏ ุงูุชูุงุก ุงูููุช
            }
            
            if (state.timeLeft % 10 === 0 && state.screen === 'exam') {
                saveCurrentAnswers(); 
            }
            renderTimer();
        }, 1000);
    }
    
    function renderTimer() {
        const timerElement = document.getElementById('timer-display');
        const saveStatusElement = document.getElementById('save-status');

        if (timerElement) {
            timerElement.textContent = formatTime(state.timeLeft);

            timerElement.classList.remove('bg-red-600', 'text-white', 'bg-yellow-400', 'text-blue-900', 'bg-red-400', 'animate-pulse');

            if (state.timeLeft <= 60) { 
                timerElement.classList.add('bg-red-600', 'text-white', 'animate-pulse');
            } else if (state.timeLeft <= 5 * 60) { 
                timerElement.classList.add('bg-red-400', 'text-white');
            } else { 
                timerElement.classList.add('bg-yellow-400', 'text-blue-900');
            }
        }
    }
    
    // --- ูุธุงุฆู ูุณุงุนุฏุฉ ---

    function formatTime(totalSeconds) {
        const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
        const seconds = String(totalSeconds % 60).padStart(2, '0');
        return `${minutes}:${seconds}`;
    }

    // --- Gemini API Utilities ---
    
    /**
     * ุชูููุฐ ุทูุจ fetch ูุน ุขููุฉ ุงูุชุฑุงุฌุน ุงูุฃุณู (Exponential Backoff)
     */
    async function fetchWithBackoff(url, options, maxRetries = 5) {
        let delay = 1000;
        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(url, options);
                if (response.ok) {
                    return response;
                }
                // ุงูุชุนุงูู ูุน ุงูุฃุฎุทุงุก ุงูุชู ูููู ุงุณุชุฑุฏุงุฏูุง (ูุซู 429 Too Many Requests)
                if (response.status === 429 || response.status >= 500) {
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // ูุถุงุนูุฉ ุงูุชุฃุฎูุฑ
                        continue;
                    }
                }
                throw new Error(`API request failed with status ${response.status}: ${await response.text()}`);
            } catch (error) {
                if (i < maxRetries - 1 && (error.message.includes('Failed to fetch') || error.message.includes('API request failed'))) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                    continue;
                }
                throw error;
            }
        }
        throw new Error("API request failed after all retries.");
    }
    
    // --- ููุฒุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู 1: ุดุฑุญ ุงูููููู (Grounded Search) ---
    
    async function callGeminiExplanation(questionText, correctAnswer) {
        // ุญูุงูุฉ ูู ุงููุดู ูู ุญุงู ุนุฏู ุชููุฑ ููุชุงุญ API
        if (!GEMINI_API_KEY) {
             const explanationDiv = document.getElementById('explanation-content');
             explanationDiv.innerHTML = '<p class="text-red-500">ุนุฐุฑุงูุ ูุธููุฉ ุงูุดุฑุญ ูุนุทูุฉ. ููุชุงุญ Gemini API ุบูุฑ ูุชููุฑ.</p>';
             return;
        }

        const query = `ุงุดุฑุญ ููููู: ${correctAnswer} ุงููุชุนูู ุจุณุคุงู: ${questionText}`;
        const systemPrompt = "ุชููู ุฏูุฑ ูุฏุฑุณ ุฃูุงุฏููู ูุชูุฑุณ ูู ุนููู ุงูุญุงุณูุจ. ูุฏู ุดุฑุญุงู ููุตูุงู ูุฏูููุงู ููุจุณุทุงู ููููููู ุงููุทููุจ ุจูุงุกู ุนูู ูุนูููุงุช ูุณุชูุฏุฉ ูู ุงูููุจ. ูุฌุจ ุฃู ุชููู ุงูุฅุฌุงุจุฉ ุดุงููุฉ ูููุฌูุฉ ููุทุงูุจุ ููู ุญุฏูุฏ ููุฑุชูู ุฅูู ุซูุงุซ ููุฑุงุช. ุฅุฐุง ูุงู ุงูููููู ุจุงููุบุฉ ุงูุฅูุฌููุฒูุฉุ ููุฏู ุดุฑุญูุง ุจุงููุบุฉ ุงูุนุฑุจูุฉ ูุน ุฐูุฑ ุงููุตุทูุญ ุงูุฅูุฌููุฒู.";
        
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
        
        const payload = {
            contents: [{ parts: [{ text: query }] }],
            tools: [{ "google_search": {} }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
        };

        const explanationDiv = document.getElementById('explanation-content');
        const loadingSpinner = document.getElementById('explanation-loading');

        explanationDiv.innerHTML = '';
        loadingSpinner.classList.remove('hidden');

        try {
            const response = await fetchWithBackoff(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const result = await response.json();
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                const text = candidate.content.parts[0].text;
                let sources = '';
                
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    const validSources = groundingMetadata.groundingAttributions
                        .map(attr => ({ uri: attr.web?.uri, title: attr.web?.title }))
                        .filter(source => source.uri && source.title);
                    
                    if (validSources.length > 0) {
                        sources = `<div class="mt-4 text-xs text-gray-600 border-t pt-2">
                                        <p class="font-bold mb-1">ุงููุตุงุฏุฑ ุงููุฑุฌุนูุฉ (Grounded):</p>
                                        <ul class="list-disc pr-5 space-y-1">
                                            ${validSources.map(s => `<li><a href="${s.uri}" target="_blank" class="text-blue-500 hover:underline">${s.title}</a></li>`).join('')}
                                        </ul>
                                   </div>`;
                    }
                }
                
                state.explanationCache[`${questionText}|${correctAnswer}`] = text + sources;
                explanationDiv.innerHTML = text.replace(/\n/g, '<br>') + sources;
            } else {
                explanationDiv.innerHTML = '<p class="text-red-500">ุนุฐุฑุงูุ ูู ูุชููู ูู ุชูููุฏ ุดุฑุญ ููููููู ูู ุงูููุช ุงูุญุงูู.</p>';
            }

        } catch (e) {
            console.error("Gemini API Error:", e);
            explanationDiv.innerHTML = `<p class="text-red-500">ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุฎุฏูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู: ${e.message}</p>`;
        } finally {
            loadingSpinner.classList.add('hidden');
        }
    }

    // --- ููุฒุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู 2: ูุฑุงุกุฉ ุงูุณุคุงู (TTS) ---

    function base64ToArrayBuffer(base64) {
        const binaryString = atob(base64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
    }

    function pcmToWav(pcm16, sampleRate) {
        const numChannels = 1;
        const bitsPerSample = 16;
        const pcmData = pcm16.buffer;

        const wav = new ArrayBuffer(44 + pcmData.byteLength);
        const view = new DataView(wav);

        // RIFF header
        writeString(view, 0, 'RIFF');
        view.setUint32(4, 36 + pcmData.byteLength, true);
        writeString(view, 8, 'WAVE');

        // FMT sub-chunk
        writeString(view, 12, 'fmt ');
        view.setUint32(16, 16, true); // Sub-chunk size: 16
        view.setUint16(20, 1, true); // Audio format (1 for PCM)
        view.setUint16(22, numChannels, true); // Number of channels
        view.setUint32(24, sampleRate, true); // Sample rate
        view.setUint32(28, sampleRate * numChannels * (bitsPerSample / 8), true); // Byte rate
        view.setUint16(32, numChannels * (bitsPerSample / 8), true); // Block align
        view.setUint16(34, bitsPerSample, true); // Bits per sample

        // Data sub-chunk
        writeString(view, 36, 'data');
        view.setUint32(40, pcmData.byteLength, true);

        // PCM data
        const pcmBytes = new Uint8Array(pcmData);
        const dataView = new Uint8Array(wav, 44);
        dataView.set(pcmBytes);

        return new Blob([wav], { type: 'audio/wav' });

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
    }
    
    async function callGeminiTTS(questionText, questionId) {
         // ุญูุงูุฉ ูู ุงููุดู ูู ุญุงู ุนุฏู ุชููุฑ ููุชุงุญ API
        if (!GEMINI_API_KEY) {
             const button = document.getElementById(`tts-button-${questionId}`);
             if (button) button.innerHTML = '๐ค TTS ูุนุทู';
             return;
        }

        state.audioPlayer.pause();
        const button = document.getElementById(`tts-button-${questionId}`);
        if (!button) return;

        // ุญุงูุฉ ุงูุฅููุงู/ุงูุชุดุบูู
        if (state.audioQuestionId === questionId) {
             state.audioQuestionId = null;
             button.innerHTML = '๐ค ุงุณุชูุน ููุณุคุงู';
             return;
        }

        // ุฅุธูุงุฑ ุญุงูุฉ ุงูุชุญููู
        button.innerHTML = 'ุฌุงุฑู ุงูุชุญููู...';
        button.disabled = true;

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${GEMINI_API_KEY}`;
        const payload = {
            contents: [{
                parts: [{ text: `ุงูุฑุฃ ุจุตูุช ูุงุถุญ ููุญุงูุฏ: ${questionText}` }]
            }],
            generationConfig: {
                responseModalities: ["AUDIO"],
                // ุงุฎุชูุงุฑ ุตูุช ููุงุณุจ ููุบุฉ ุงูุนุฑุจูุฉ
                speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } 
            },
        };

        try {
            const response = await fetchWithBackoff(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const result = await response.json();
            const part = result?.candidates?.[0]?.content?.parts?.[0];
            const audioData = part?.inlineData?.data;
            const mimeType = part?.inlineData?.mimeType;

            if (audioData && mimeType && mimeType.startsWith("audio/")) {
                // ุงุณุชุฎุฑุงุฌ ูุนุฏู ุงูุนููุฉ ูู ุงูู MIME type (ุนุงุฏุฉ ูููู 16000)
                const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000; 

                const pcmData = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmData);
                const wavBlob = pcmToWav(pcm16, sampleRate);
                const audioUrl = URL.createObjectURL(wavBlob);
                
                state.audioPlayer.src = audioUrl;
                
                // ุชุญุฏูุซ ุญุงูุฉ ุงูุชุดุบูู
                state.audioQuestionId = questionId;
                state.audioPlayer.play();
                button.innerHTML = 'โน ุฅููุงู ุงูุชุดุบูู';
                
                // ุฅุนุงุฏุฉ ุงูุฒุฑ ููุถุนู ุงูุฃุตูู ุนูุฏ ุงูุงูุชูุงุก
                state.audioPlayer.onended = () => {
                    button.innerHTML = '๐ค ุงุณุชูุน ููุณุคุงู';
                    button.disabled = false;
                    state.audioQuestionId = null;
                };

            } else {
                 button.innerHTML = '๐ค ุฎุทุฃ ูู ุงูุตูุช';
                 console.error("Invalid audio data received.");
            }

        } catch (e) {
            console.error("Gemini TTS API Error:", e);
            button.innerHTML = '๐ค ุฎุทุฃ ูู ุงูุงุชุตุงู';
        } finally {
             // ุชุนุทูู ุงูุฒุฑ ูุชู ุงูุชุญูู ููู ุจุงููุงูู ุฏุงุฎู ุงูุฏุงูุฉ ููุญุงูุงุช ุงููุฎุชููุฉ (ุชุญูููุ ุชุดุบููุ ุฎุทุฃ)
             if (button.innerHTML.includes('ุงุณุชูุน') || button.innerHTML.includes('ุฎุทุฃ')) {
                button.disabled = false;
             }
        }
    }


    // --- ูุนุงูุฌุงุช ุงูุฃุญุฏุงุซ (Handlers) ---

    async function handleRegisterSubmit(event) {
        event.preventDefault();
        const nameInput = document.getElementById('student-name');
        const seatInput = document.getElementById('seat-number');
        const errorMessageDiv = document.getElementById('error-message');
        
        const name = nameInput.value.trim();
        const seat = seatInput.value.trim();

        if (name && seat) {
            state.errorMessage = null;
            
            const newSessionId = crypto.randomUUID();

            const sessionData = {
                sessionId: newSessionId,
                studentName: name,
                seatNumber: seat,
                questions: state.examQuestions.map(q => ({ id: q.id, type: q.type, text: q.text, options: q.options || [], correct: q.correct || q.modelAnswer })),
                answers: {},
                mcqScore: 0,
                status: 'active', 
                startTime: new Date().toISOString(),
                userId: userId, 
            };

            state.sessionId = newSessionId;
            state.studentName = name;
            state.seatNumber = seat;
            localStorage.setItem('current_exam_session_id', newSessionId);

            if (state.isAuthReady && db) {
                try {
                    await saveSession(sessionData);
                } catch (e) {
                    console.error("Failed to save session to Firebase:", e);
                    state.errorMessage = 'ูุดู ูู ุญูุธ ุจูุงูุงุช ุงูุฌูุณุฉ ุนูู ุงูุณุญุงุจุฉุ ุณุชุชู ุงููุชุงุจุนุฉ ุจุฏูู ุญูุธ ุฏุงุฆู.';
                }
            }

            state.screen = 'exam';
            startTimer();
            render();
            
        } else {
            state.errorMessage = 'ุงูุฑุฌุงุก ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ.';
            render();
        }
    }

    async function saveCurrentAnswers() {
        if (state.screen === 'exam' && state.sessionId && state.isAuthReady && db) {
            try {
                await saveSession({ answers: state.answers });
                const statusElement = document.getElementById('save-status');
                if (statusElement) {
                    statusElement.textContent = 'ุชู ุญูุธ ุงูุฅุฌุงุจุงุช ุชููุงุฆููุง.';
                    statusElement.classList.remove('hidden', 'bg-red-100', 'text-red-700');
                    statusElement.classList.add('bg-green-100', 'text-green-700');
                    setTimeout(() => {
                        statusElement.classList.add('hidden');
                    }, 3000);
                }
            } catch (e) {
                console.warn("Failed to auto-save answers:", e);
                const statusElement = document.getElementById('save-status');
                if (statusElement) {
                    statusElement.textContent = 'ุฎุทุฃ ูู ุงูุญูุธ ุงูุชููุงุฆู.';
                    statusElement.classList.remove('hidden', 'bg-green-100', 'text-green-700');
                    statusElement.classList.add('bg-red-100', 'text-red-700');
                }
            }
        }
    }

    function handleAnswerChange(questionId, answer) {
        state.answers[questionId] = answer;
        if (state.examQuestions.find(q => q.id === questionId)?.type === 'mcq') {
             saveCurrentAnswers();
        }
    }

    async function handleSubmitExam(isTimeout = false) {
        if (state.timerInterval) clearInterval(state.timerInterval);

        let correctCount = 0;
        const mcqQ = state.examQuestions.filter(q => q.type === 'mcq');
        const mcqCount = mcqQ.length;

        mcqQ.forEach(q => {
            if (state.answers[q.id] === q.correct) {
                correctCount++;
            }
        });
        state.mcqScore = correctCount;

        if (state.sessionId && db && state.isAuthReady) {
            try {
                const sessionRef = getSessionRef(state.sessionId);
                await setDoc(sessionRef, {
                    answers: state.answers,
                    mcqScore: state.mcqScore,
                    status: 'completed',
                    endTime: new Date().toISOString(),
                    submissionType: isTimeout ? 'Timeout' : 'Manual',
                }, { merge: true });
            } catch (e) {
                console.error("Failed to update final session state:", e);
            }
        }
        
        state.screen = 'results';
        render();
    }


    // --- ูุธุงุฆู ุงูุนุฑุถ (Render) ---

    function renderLoadingScreen() {
        app.innerHTML = `
            <div class="text-center p-10 bg-white rounded-xl shadow-lg mt-20 w-full max-w-lg">
                <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600 mx-auto mb-4"></div>
                <p class="text-xl text-blue-700 font-semibold">ุฌุงุฑู ุชููุฆุฉ ุงููุธุงู ูุงูุชุญูู ูู ุงูุฌูุณุฉ...</p>
                <p class="text-sm text-gray-500 mt-2">ูุฑุฌู ุงูุงูุชุธุงุฑ ููููุงู ููุชุญูู ูู ุงูุงุชุตุงู ู ุงุณุชุฆูุงู ุฃู ุงุฎุชุจุงุฑ ุณุงุจู.</p>
            </div>
        `;
    }

    function renderRegisterScreen() {
        app.innerHTML = `
            <div class="container-card bg-white p-8 md:p-12 rounded-xl border border-gray-200 w-full max-w-lg mx-auto border-t-8 border-indigo-600">
                <h1 class="text-3xl font-bold text-center text-indigo-800 mb-2">ุงุฎุชุจุงุฑ ุงูุญุงุณูุจ</h1>
                <p class="text-center text-gray-600 mb-8">ุงูุฑุฌุงุก ุชุณุฌูู ุจูุงูุงุชู ูุจุฏุก ุงูุงุฎุชุจุงุฑ (ุงููุฏุฉ: 45 ุฏูููุฉ).</p>

                ${state.errorMessage ? `<p id="error-message" class="text-red-500 text-sm mt-2 text-center bg-red-100 p-2 rounded-lg mb-4">${state.errorMessage}</p>` : `<p id="error-message" class="hidden"></p>`}
             

                <form id="register-form" class="space-y-6">
                    <div>
                        <label for="student-name" class="block text-lg font-medium text-gray-700 mb-2">ุงูุงุณู:</label>
                        <input type="text" id="student-name" name="student-name" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                               placeholder="ุงูุงุณู ุงูุซูุงุซู ููุทุงูุจ">
                    </div>
                    <div>
                        <label for="seat-number" class="block text-lg font-medium text-gray-700 mb-2">ุฑูู ุงูุฌููุณ:</label>
                        <input type="text" id="seat-number" name="seat-number" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                               placeholder="ุฑูู ุงูุฌููุณ">
                    </div>
                    <button type="submit"
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg text-xl transition duration-300 transform hover:scale-[1.01] shadow-lg">
                        ุงุจุฏุฃ ุงูุงุฎุชุจุงุฑ ุงูุขู
                    </button>
                </form>
                <div class="mt-4 p-3 bg-blue-100 text-blue-800 rounded-lg text-sm text-center">
                    <p>ููุงุญุธุฉ: ุฅุฐุง ูุงู ุงูุงุชุตุงู ูุชุงุญุงูุ ุณูุชู ุชุณุฌูู ุฅุฌุงุจุงุชู ุชููุงุฆููุง ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.</p>
                </div>
            </div>
        `;
        document.getElementById('register-form').addEventListener('submit', handleRegisterSubmit);
    }


    function renderExamScreen() {
        const mcqQ = state.examQuestions.filter(q => q.type === 'mcq');
        const writtenQ = state.examQuestions.filter(q => q.type === 'written');
        const mcqCount = mcqQ.length;
        const totalQuestions = mcqQ.length + writtenQ.length;

        app.innerHTML = `
            <!-- ุดุฑูุท ุนููู (Sticky Header) ูุน ุงููุคูุช ูุญุงูุฉ ุงูุญูุธ -->
            <div class="header-bar bg-gray-800 text-white p-4 md:p-6 rounded-t-xl flex flex-col md:flex-row justify-between items-center sticky top-0 z-20 shadow-xl">
                
                <div class="flex flex-col text-right mb-3 md:mb-0">
                    <span class="text-sm md:text-base">ุงูุทุงูุจ: <span class="font-semibold text-yellow-300">${state.studentName}</span></span>
                    <span class="text-sm md:text-base">ุฑูู ุงูุฌููุณ: <span class="font-semibold text-yellow-300">${state.seatNumber}</span></span>
                </div>
                
                <div class="flex items-center space-x-2 space-x-reverse bg-gray-700 p-2 rounded-xl">
                    <!-- ุฃููููุฉ ุงูุณุงุนุฉ -->
                    <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <!-- ุนุฑุถ ุงููุคูุช -->
                    <div class="text-2xl md:text-3xl font-mono timer-display px-3 py-0.5 rounded-lg shadow-inner" id="timer-display">
                        ${formatTime(state.timeLeft)}
                    </div>
                </div>

                <div id="save-status" class="hidden text-xs mt-2 md:mt-0 px-3 py-1 rounded-full"></div>
            </div>

            <div class="container-card bg-white p-6 md:p-8 rounded-b-xl border border-gray-200 border-t-0">
                ${!state.isAuthReady ? `
                    <div class="p-3 bg-red-100 text-red-800 rounded-lg text-sm text-center mb-6 border border-red-300 font-bold">
                         โ๏ธ ูุถุน ุนุฏู ุงูุงุชุตุงู: ูู ูุชู ุญูุธ ุฅุฌุงุจุงุชู ุนูู ุงูุณุญุงุจุฉ ุฅูุง ุนูุฏ ุงูุงุชุตุงู ุจุงูุดุจูุฉ ูุฑุฉ ุฃุฎุฑู. ูุฑุฌู ุงูุญูุธ ูุจู ุงูุฅุบูุงู.
                    </div>
                ` : ''}

                <h2 class="text-2xl font-bold text-gray-800 mb-8 border-b-2 pb-3 text-indigo-600">
                    ุฃุณุฆูุฉ ุงูุงุฎุชุจุงุฑ (ูุฌููุน ุงูุฃุณุฆูุฉ: ${totalQuestions})
                </h2>

                <form id="exam-form" class="space-y-12">
                    
                    <!-- ุฃุณุฆูุฉ ุงูุงุฎุชูุงุฑุงุช -->
                    <section>
                        <h3 class="text-xl font-bold text-gray-700 mb-6 p-2 bg-indigo-50 border-r-4 border-indigo-500 rounded">
                            ุงูุฌุฒุก ุงูุฃูู: ุฃุณุฆูุฉ ุงูุงุฎุชูุงุฑุงุช ุงููุชุนุฏุฏุฉ (${mcqCount} ุณุคุงู)
                        </h3>
                        ${mcqQ.map((q, index) => `
                            <div class="question-block p-5 mb-5 border border-gray-200 rounded-lg transition duration-200">
                                <div class="flex justify-between items-center mb-4">
                                    <p class="text-lg font-bold text-gray-800">
                                        <span class="font-extrabold text-indigo-700 ml-2">${index + 1}.</span>
                                        ${q.text}
                                    </p>
                                    <!-- ุฒุฑ ูุฑุงุกุฉ ุงูุณุคุงู (TTS) -->
                                    <button type="button" id="tts-button-${q.id}" onclick="window.callGeminiTTS('${q.text.replace(/'/g, "\\'")}', ${q.id})"
                                            class="flex items-center text-sm font-semibold bg-blue-500 text-white py-1 px-3 rounded-full hover:bg-blue-600 transition duration-150 shadow-md transform hover:scale-105 disabled:opacity-50">
                                        ๐ค ุงุณุชูุน ููุณุคุงู
                                    </button>
                                </div>
                                <div class="space-y-3">
                                    ${q.options.map(option => `
                                        <label class="flex items-center p-3 rounded-md cursor-pointer hover:bg-indigo-50 transition duration-150 ${state.answers[q.id] === option ? 'user-selected-mcq bg-blue-100' : 'bg-white'}">
                                            <input type="radio" name="q-${q.id}" value="${option}"
                                                   class="h-5 w-5 text-indigo-600 focus:ring-indigo-500"
                                                   onchange="window.handleAnswerChange(${q.id}, this.value)"
                                                   ${state.answers[q.id] === option ? 'checked' : ''}>
                                            <span class="mr-3 text-gray-700">${option}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </section>

                    <!-- ุงูุฃุณุฆูุฉ ุงููุธุฑูุฉ -->
                    <section>
                        <h3 class="text-xl font-bold text-gray-700 mb-6 p-2 bg-indigo-50 border-r-4 border-indigo-500 rounded">
                            ุงูุฌุฒุก ุงูุซุงูู: ุงูุฃุณุฆูุฉ ุงููุธุฑูุฉ (${writtenQ.length} ุณุคุงู)
                        </h3>
                        ${writtenQ.map((q, index) => `
                            <div class="question-block p-5 mb-5 border border-gray-200 rounded-lg transition duration-200">
                                <div class="flex justify-between items-center mb-4">
                                    <p class="text-lg font-bold text-gray-800">
                                        <span class="font-extrabold text-indigo-700 ml-2">${mcqCount + index + 1}.</span>
                                        ${q.text}
                                    </p>
                                    <!-- ุฒุฑ ูุฑุงุกุฉ ุงูุณุคุงู (TTS) -->
                                     <button type="button" id="tts-button-${q.id}" onclick="window.callGeminiTTS('${q.text.replace(/'/g, "\\'")}', ${q.id})"
                                            class="flex items-center text-sm font-semibold bg-blue-500 text-white py-1 px-3 rounded-full hover:bg-blue-600 transition duration-150 shadow-md transform hover:scale-105 disabled:opacity-50">
                                        ๐ค ุงุณุชูุน ููุณุคุงู
                                    </button>
                                </div>
                                <textarea id="q-${q.id}" rows="6"
                                          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mt-2 transition duration-150"
                                          placeholder="ุฃุฏุฎู ุฅุฌุงุจุชู ุงูููุตูุฉ ููุง..."
                                          oninput="window.handleAnswerChange(${q.id}, this.value)">${state.answers[q.id] || ''}</textarea>
                                          <p class="text-xs text-gray-500 mt-2">ููุงุญุธุฉ: ูุชู ุญูุธ ุงูุฅุฌุงุจุฉ ุงููุธุฑูุฉ ุชููุงุฆููุง ูู 10 ุซูุงูู (ุฅุฐุง ูุงู ุงูุงุชุตุงู ูุชููุฑุงู).</p>
                            </div>
                        `).join('')}
                    </section>

                    <div class="flex justify-center mt-10 pb-4">
                        <button type="button" onclick="window.handleSubmitExam()"
                                class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg text-xl transition duration-300 transform hover:scale-[1.01] shadow-xl">
                            ุฅููุงุก ุงูุงุฎุชุจุงุฑ ูุชุณููู ุงูุฅุฌุงุจุงุช
                        </button>
                    </div>
                </form>
            </div>
        `;
        renderTimer();
    }
    
    function renderResultsScreen() {
        const mcqQ = state.examQuestions.filter(q => q.type === 'mcq');
        const writtenQ = state.examQuestions.filter(q => q.type === 'written');
        const mcqCount = mcqQ.length;
        
        const percentage = ((state.mcqScore / mcqCount) * 100).toFixed(1);
        const gradeColor = state.mcqScore >= mcqCount * 0.8 ? 'text-green-600' : state.mcqScore >= mcqCount * 0.5 ? 'text-yellow-600' : 'text-red-600';

        app.innerHTML = `
            <div class="container-card bg-white p-8 md:p-12 rounded-xl border border-gray-200 w-full mx-auto border-t-8 border-indigo-600">
                <h1 class="text-4xl font-extrabold text-center text-indigo-800 mb-2">ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ</h1>
                <p class="text-center text-gray-600 mb-8">ุชูููู ุฃุณุฆูุฉ ุงูุงุฎุชูุงุฑุงุช ููุฑุงุฌุนุฉ ุงูุฃุณุฆูุฉ ุงููุธุฑูุฉ.</p>

                <div class="text-center mb-10 p-6 rounded-xl bg-gray-50 border border-gray-200">
                    <p class="text-xl text-gray-700">ุงูุทุงูุจ: <span class="font-bold text-blue-600">${state.studentName}</span></p>
                    <p class="text-xl text-gray-700">ุฑูู ุงูุฌููุณ: <span class="font-bold text-blue-600">${state.seatNumber}</span></p>
                    <p class="text-2xl font-bold mt-4 text-gray-800">ุฏุฑุฌุชู ูู ุฃุณุฆูุฉ ุงูุงุฎุชูุงุฑุงุช:</p>
                    <p class="text-6xl font-black ${gradeColor} my-4">${state.mcqScore} / ${mcqCount}</p>
                    <p class="text-xl font-semibold text-gray-600">ุงููุณุจุฉ ุงููุฆููุฉ: <span class="${gradeColor} font-extrabold">${percentage}%</span></p>
                    <p class="text-sm text-red-500 mt-4">ููุงุญุธุฉ: ุงูุฃุณุฆูุฉ ุงููุธุฑูุฉ (ุงูุซุงููุฉ) ุบูุฑ ูููููุฉ ุขูููุง ูุชุฎุถุน ููุฑุงุฌุนุฉ ุงููุนูู.</p>
                </div>

                <!-- ูุณู ุงูุดุฑุญ ุงููุนุฒุฒ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู -->
                <div id="explanation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
                    <div class="bg-white p-6 rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-start border-b pb-3 mb-4">
                            <h3 class="text-2xl font-bold text-indigo-700">ุดุฑุญ ุงูููููู ุจูุงุณุทุฉ Gemini โจ</h3>
                            <button onclick="document.getElementById('explanation-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                        </div>
                        <div id="explanation-content" class="text-gray-700 text-lg leading-relaxed mb-4"></div>
                        <div id="explanation-loading" class="hidden text-center p-4">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500 mx-auto mb-2"></div>
                            <p class="text-indigo-600">ุฌุงุฑู ุงูุจุญุซ ูุชูุฏูู ุงูุดุฑุญ ุงูููุตูุ ูุฑุฌู ุงูุงูุชุธุงุฑ...</p>
                        </div>
                    </div>
                </div>


                <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3 text-indigo-600">
                    ูุฑุงุฌุนุฉ ุฅุฌุงุจุงุช ุงูุงุฎุชูุงุฑุงุช
                </h2>

                <div class="space-y-4">
                    ${mcqQ.map((q, index) => {
                        const isCorrect = state.answers[q.id] === q.correct;
                        const cardClass = isCorrect ? 'correct-answer' : 'incorrect-answer';
                        const userAns = state.answers[q.id] || 'ูู ุชุชู ุงูุฅุฌุงุจุฉ';
                        
                        let correctOptionLetter = '';
                        q.options.forEach((option, i) => {
                            if (option === q.correct) {
                                correctOptionLetter = String.fromCharCode(97 + i); // 97 ูู ููุฏ 'a'
                            }
                        });

                        const explanationKey = `${q.text}|${q.correct}`;
                        const cachedExplanation = state.explanationCache[explanationKey];

                        return `
                            <div class="p-4 rounded-lg shadow ${cardClass} transition duration-200">
                                <div class="flex justify-between items-start">
                                    <p class="text-lg font-bold text-gray-900 mb-2">
                                        <span class="font-extrabold text-indigo-700 ml-2">${index + 1}.</span>
                                        ${q.text}
                                    </p>
                                    <button onclick="window.handleExplainClick(${q.id})"
                                            class="flex items-center text-sm font-semibold bg-indigo-600 text-white py-1 px-3 rounded-full hover:bg-indigo-700 transition duration-150 transform hover:scale-105 whitespace-nowrap">
                                        โจ ุงุดุฑุญ ูู ุงูููููู
                                    </button>
                                </div>
                                
                                <p class="text-sm font-semibold ${isCorrect ? 'text-green-700' : 'text-red-700'} mb-2 border-b border-dashed pb-1">
                                    ${isCorrect ? 'โ ุงูุฅุฌุงุจุฉ ุตุญูุญุฉ. ' : 'โ ุงูุฅุฌุงุจุฉ ุฎุงุทุฆุฉ. '}
                                </p>
                                <p class="text-sm text-gray-800 mb-1">
                                    <span class="font-semibold">ุฅุฌุงุจุชู:</span>
                                    <span class="${!isCorrect && userAns !== 'ูู ุชุชู ุงูุฅุฌุงุจุฉ' ? 'line-through text-red-500' : ''} ${userAns !== 'ูู ุชุชู ุงูุฅุฌุงุจุฉ' ? 'p-1 rounded user-selected-mcq bg-blue-100' : 'italic'}">${userAns}</span>
                                </p>
                                ${!isCorrect ? `<p class="text-sm text-green-800 font-semibold mt-1">
                                    <span class="font-semibold">ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ (${correctOptionLetter}):</span>
                                    <span class="font-normal bg-green-200 rounded p-1">${q.correct}</span>
                                </p>` : ''}
                                
                                <!-- ุนุฑุถ ุงูุดุฑุญ ุงููุฎุฒู ูุคูุชุงู -->
                                ${cachedExplanation ? `
                                    <div class="mt-4 p-3 bg-indigo-50 border-r-4 border-indigo-400 rounded-lg text-sm text-gray-700">
                                        <p class="font-bold text-indigo-800 mb-2">ุดุฑุญ ุงูููููู (ูุฎุฒู ูุคูุชุงู):</p>
                                        <div class="text-xs max-h-24 overflow-y-auto">${cachedExplanation}</div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>

                <h2 class="text-2xl font-bold text-gray-800 pt-8 mt-10 border-t-2 border-gray-200 mb-6 text-indigo-600">
                    ูููุฐุฌ ุฅุฌุงุจุฉ ุงูุฃุณุฆูุฉ ุงููุธุฑูุฉ
                </h2>
                <div class="space-y-6">
                    ${writtenQ.map((q, index) => `
                        <div class="p-4 rounded-lg border border-gray-300 bg-gray-50 shadow-sm">
                            <div class="flex justify-between items-start">
                                <p class="text-lg font-bold text-gray-900 mb-3">
                                    <span class="font-extrabold text-indigo-700 ml-2">${mcqCount + index + 1}.</span>
                                    ${q.text}
                                </p>
                                <button onclick="window.handleExplainClick(${q.id})"
                                        class="flex items-center text-sm font-semibold bg-indigo-600 text-white py-1 px-3 rounded-full hover:bg-indigo-700 transition duration-150 transform hover:scale-105 whitespace-nowrap">
                                    โจ ุงุดุฑุญ ูู ุงูููููู
                                </button>
                            </div>
                            
                            <div class="mb-3 p-3 rounded bg-blue-100 border-r-4 border-blue-500">
                                <p class="text-sm font-semibold text-blue-800 mb-1">ุฅุฌุงุจุชู ุงููุณุฌูุฉ:</p>
                                <p class="text-gray-700 whitespace-pre-wrap">${state.answers[q.id] || 'ูู ุชูู ุจุงูุฅุฌุงุจุฉ ุนูู ูุฐุง ุงูุณุคุงู.'}</p>
                            </div>
                            
                            <div class="p-3 rounded bg-green-100 border-r-4 border-green-500">
                                <p class="text-sm font-semibold text-green-800 mb-1">ูููุฐุฌ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ:</p>
                                <p class="text-gray-700 whitespace-pre-wrap">${q.modelAnswer}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="flex justify-center mt-10">
                    <button onclick="window.handleRestart()"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg text-xl transition duration-300 transform hover:scale-[1.01] shadow-lg">
                        ุชุณุฌูู ุงูุฎุฑูุฌ ูุงูุจุฏุก ูู ุฌุฏูุฏ
                    </button>
                </div>
            </div>
        `;
    }


    function render() {
        if (state.screen === 'loading') {
            renderLoadingScreen();
        } else if (state.screen === 'register') {
            renderRegisterScreen();
        } else if (state.screen === 'exam') {
            renderExamScreen();
        } else if (state.screen === 'results') {
            renderResultsScreen();
        }
    }
    
    // ูุนุงูุฌ ุถุบุทุฉ ุฒุฑ ุงูุดุฑุญ
    window.handleExplainClick = (questionId) => {
        const question = state.examQuestions.find(q => q.id === questionId);
        if (!question) return;

        const correctAns = question.type === 'mcq' ? question.correct : question.modelAnswer;
        const explanationKey = `${question.text}|${correctAns}`;
        const cachedExplanation = state.explanationCache[explanationKey];

        const explanationDiv = document.getElementById('explanation-content');
        const modal = document.getElementById('explanation-modal');

        modal.classList.remove('hidden');

        if (cachedExplanation) {
            // ุนุฑุถ ุงูุดุฑุญ ุงููุฎุฒู ูุคูุชุงู
            explanationDiv.innerHTML = cachedExplanation;
            document.getElementById('explanation-loading').classList.add('hidden');
        } else {
            // ุงุณุชุฏุนุงุก Gemini ูุชูููุฏ ุงูุดุฑุญ
            callGeminiExplanation(question.text, correctAns);
        }
    };
    
    window.callGeminiTTS = callGeminiTTS;
    window.handleRestart = () => {
        localStorage.removeItem('current_exam_session_id');
        window.location.reload();
    };

    // ุชุตุฏูุฑ ุงูุฏูุงู ุงูุนุงูุฉ ููุนุงูุฌุฉ ุงูุฃุญุฏุงุซ
    window.handleAnswerChange = handleAnswerChange;
    window.handleSubmitExam = handleSubmitExam;

    // ุงูุจุฏุก ุจุชููุฆุฉ Firebase ุนูุฏ ุชุญููู ุงูุตูุญุฉ
    document.addEventListener('DOMContentLoaded', initializeFirebase);

</script>
</body>
</html>